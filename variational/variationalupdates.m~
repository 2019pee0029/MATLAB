function [varargout, peval]=variationalupdates(varargin, peval)
% [varargout, peval]=variationalupdates(varargin, peval)
% dvec=varargin{1};
% w = varargin{2};
% alph = varargin{3};
% beta = varargin{4};
% a = varargin{5};
% b = varargin{6};
if ~isfield(peval,'showprogres')
    showprogres = 0;
else 
    % plots the progress of the evaluation
    showprogres = peval.showprogres;
end

dvec=varargin{1};
w = varargin{2};
alph = varargin{3};
beta = varargin{4};
a = varargin{5};
b = varargin{6};


lb(1)=sum(lowerbound(dvec, w, alph, beta, a, b));
for updateindex=1:peval.maxiter;
    n=update_n(w, a, b);
    a(1:peval.ncomp-1,:)=update_a(dvec,n(:,1:peval.ncomp-1,:),alph(:,1:peval.ncomp-1));
    w(:,1:peval.ncomp-1)=update_w(dvec, n(:,1:peval.ncomp-1,:));
    lb(updateindex+1)=sum(lowerbound(dvec, w, alph, beta, a, b));
    if showprogress
        imstiled(reshape(w, peval.nx, peval.ny, peval.ncomp),10, 'gray',[],[],1)
        plot(lb(2:end))
    end
end

varargout = struct('w',w,'a',a,'lb',lb);
