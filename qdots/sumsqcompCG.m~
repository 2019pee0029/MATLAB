function sumsq = sumsqcompCG(dpixc, res, htrace1, htrace2, peval)
ROIx=peval.ROIx(1):peval.ROIx(2);
ROIy=peval.ROIy(1):peval.ROIy(2);
ROIz=peval.ROIz(1):peval.ROIz(2);
dpixcs = dpixc(ROIx,ROIy,ROIz);
dveccs = reshape(dpixcs, peval.numpix, peval.nt);
htr =exp(res.htrace);
for jj=1:size(htrace1,1) %avg
    for ii=1:size(htrace1,3) %iter
        htr(ii,3,:)=res.h(3,:);
        htmp=[squeeze(exp(htrace1(jj,:,ii))); squeeze(exp(htrace2(jj,:,ii))); squeeze(exp(res.htrace(ii,3,:)))'];
        itmp=res.w*htmp;
        itmp=res.w*squeeze(htr(ii,:,:));
        isq=(dveccs-itmp).^2;
        sumsq(jj,ii)=sum(isq(:));
    end
end


for jj=1:size(htrace1,1)
    for ii=1:size(htrace1,3)
        %         itmp=res.w*squeeze(res.htrace(ii,:,:));
        itmp=res.w*[squeeze(htrace1(jj,:,ii)); squeeze(htrace2(jj,:,ii)); squeeze(res.htrace(ii,3,:))'];
        isq=(dveccs-itmp).^2;
        sumsq(ii,jj)=sum(isq(:));
    end
end
